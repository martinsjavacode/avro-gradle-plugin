# Usage Examples - Avro Gradle Plugin

## Basic Setup

### build.gradle.kts
```kotlin
plugins {
    id("io.github.martinsjavacode.avro-gradle-plugin") version "1.1.0"
}

avro {
    sourceDir = "src/main/avro"
    outputDir = "build/generated-sources/avro"
}
```

## Advanced Configuration

### Full Configuration Example
```kotlin
avro {
    // Source and output directories
    sourceDir = "src/main/avro"
    outputDir = "build/generated-sources/avro"
    
    // Code generation options
    fieldVisibility = "PRIVATE"
    stringType = "CharSequence"
    optionalGetters = true
    useDecimalLogical = true
    createNullSafeAnnotations = true
    
    // Build optimization
    enableCache = true
    validateBeforeGenerate = true
    
    // Future features
    generateBuilders = false
    addCustomHeader = """
        // Generated by Avro Gradle Plugin
        // Do not modify manually
    """.trimIndent()
}
```

## Schema Examples

### 1. JSON Schema (.avsc)
```json
{
  "type": "record",
  "name": "User",
  "namespace": "com.example.model",
  "doc": "User information",
  "fields": [
    {
      "name": "id",
      "type": "long",
      "doc": "User ID"
    },
    {
      "name": "username",
      "type": "string"
    },
    {
      "name": "email",
      "type": ["null", "string"],
      "default": null
    },
    {
      "name": "createdAt",
      "type": {
        "type": "long",
        "logicalType": "timestamp-millis"
      }
    }
  ]
}
```

### 2. Protocol Schema (.avpr)
```json
{
  "protocol": "UserService",
  "namespace": "com.example.service",
  "types": [
    {
      "type": "record",
      "name": "User",
      "fields": [
        {"name": "id", "type": "long"},
        {"name": "name", "type": "string"}
      ]
    }
  ],
  "messages": {
    "getUser": {
      "request": [{"name": "id", "type": "long"}],
      "response": "User"
    }
  }
}
```

## Gradle Tasks

### Generate Classes
```bash
# Generate Java classes from schemas
./gradlew generateAvroClasses

# With clean
./gradlew clean generateAvroClasses

# Build project (includes generation)
./gradlew build
```

### Validate Schemas
```bash
# Validate schemas without generating
./gradlew validateAvroSchemas

# Validate and generate
./gradlew validateAvroSchemas generateAvroClasses
```

### View Reports
```bash
# Generate and open report
./gradlew generateAvroClasses
open build/reports/avro/avro-generation-report.html
```

## Project Structure

```
my-project/
├── build.gradle.kts
├── src/
│   ├── main/
│   │   ├── avro/                    # Schema files
│   │   │   ├── user.avsc
│   │   │   └── protocol.avpr
│   │   └── java/
│   │       └── com/example/
│   └── test/
└── build/
    ├── generated-sources/
    │   └── avro/                    # Generated classes
    │       └── com/example/model/
    │           ├── User.java
    │           └── UserProfile.java
    └── reports/
        └── avro/
            └── avro-generation-report.html
```

## Integration with Java

### Using Generated Classes
```java
import com.example.model.User;
import com.example.model.UserRole;

public class UserService {
    public void createUser() {
        User user = User.newBuilder()
            .setId(1L)
            .setUsername("john.doe")
            .setEmail("john@example.com")
            .setCreatedAt(System.currentTimeMillis())
            .build();
        
        // Use the user object
        System.out.println("Created user: " + user.getUsername());
    }
}
```

### Serialization Example
```java
import org.apache.avro.file.DataFileWriter;
import org.apache.avro.io.DatumWriter;
import org.apache.avro.specific.SpecificDatumWriter;
import com.example.model.User;

public class AvroSerializer {
    public void serialize(User user, String filename) throws IOException {
        DatumWriter<User> datumWriter = new SpecificDatumWriter<>(User.class);
        DataFileWriter<User> dataFileWriter = new DataFileWriter<>(datumWriter);
        
        dataFileWriter.create(user.getSchema(), new File(filename));
        dataFileWriter.append(user);
        dataFileWriter.close();
    }
}
```

## Multi-Module Projects

### Root build.gradle.kts
```kotlin
plugins {
    id("io.github.martinsjavacode.avro-gradle-plugin") version "1.1.0" apply false
}

subprojects {
    apply(plugin = "io.github.martinsjavacode.avro-gradle-plugin")
    
    configure<AvroPluginExtension> {
        sourceDir = "src/main/avro"
        outputDir = "build/generated-sources/avro"
        fieldVisibility = "PRIVATE"
    }
}
```

### Module-specific Configuration
```kotlin
// module-a/build.gradle.kts
avro {
    sourceDir = "schemas"  // Override for this module
    stringType = "String"
}

// module-b/build.gradle.kts
avro {
    sourceDir = "avro-schemas"
    stringType = "CharSequence"
    optionalGetters = true
}
```

## CI/CD Integration

### GitHub Actions
```yaml
name: Build

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          
      - name: Validate Schemas
        run: ./gradlew validateAvroSchemas
        
      - name: Build with Gradle
        run: ./gradlew build
        
      - name: Upload Report
        uses: actions/upload-artifact@v3
        with:
          name: avro-report
          path: build/reports/avro/
```

## Troubleshooting

### Common Issues

#### 1. Schema not found
```bash
# Check source directory
./gradlew validateAvroSchemas --info
```

#### 2. Cache issues
```bash
# Clear cache and rebuild
./gradlew clean --no-build-cache
./gradlew generateAvroClasses
```

#### 3. Validation errors
```bash
# Run validation with stack trace
./gradlew validateAvroSchemas --stacktrace
```

#### 4. Generated classes not found
```kotlin
// Add to build.gradle.kts
sourceSets {
    main {
        java {
            srcDir("build/generated-sources/avro")
        }
    }
}
```

## Best Practices

1. **Version Control**: Don't commit generated classes
   ```gitignore
   build/generated-sources/
   build/reports/avro/
   ```

2. **Schema Organization**: Group related schemas
   ```
   src/main/avro/
   ├── users/
   │   ├── user.avsc
   │   └── profile.avsc
   └── orders/
       ├── order.avsc
       └── payment.avsc
   ```

3. **Validation**: Always validate before committing
   ```bash
   git add src/main/avro/
   ./gradlew validateAvroSchemas
   git commit -m "Add new schema"
   ```

4. **Documentation**: Add docs to schemas
   ```json
   {
     "type": "record",
     "name": "User",
     "doc": "Represents a user in the system",
     "fields": [
       {
         "name": "id",
         "type": "long",
         "doc": "Unique identifier"
       }
     ]
   }
   ```
